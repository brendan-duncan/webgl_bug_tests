<html>
    <body>
        <script type="module">
            import { GLContext } from "./loki/gl/gl_context.js";
            import { GLPlaneMesh } from "./loki/gl/shapes/gl_plane_mesh.js";
            import { GLShader } from "./loki/gl/gl_shader.js";
            import { GLTexture } from "./loki/gl/gl_texture.js";
            import { GLFramebuffer } from "./loki/gl/gl_frame_buffer.js";
            import { GLRenderbuffer } from "./loki/gl/gl_render_buffer.js";

            const width = 800;
            const height = 600;

            const gl = new GLContext({ width, height, preserveDrawingBuffer: false });
            document.body.appendChild(gl.canvas);

            const plane = new GLPlaneMesh(gl, { width: 1.9, height: 1.9, z: 0.9 } );
            const plane2 = new GLPlaneMesh(gl, { z: 0.5 });

            const texture = new GLTexture(gl, {w: 1, h: 1, data: [255,255,0,255]});
            const texture2 = new GLTexture(gl, {w: 1, h: 1, data: [0,0,255,255]});
            const shader = new GLShader(gl, 
                `#version 300 es
                in vec3 a_P;
                in vec2 a_uv;
                out vec2 textureCoord;
                uniform float y;
                void main(void) {
                    gl_Position = vec4(a_P.x, a_P.y + y, a_P.z, 1.0);
                    textureCoord = a_uv;
                }`,
                `#version 300 es
                precision highp float;
                uniform sampler2D baseColor;
                in vec2 textureCoord;
                out vec4 FragColor;
                void main(void) {
                    FragColor = texture(baseColor, textureCoord);
                }`);

            // Rendering to an MSAA depth texture ...
            const msaaSamples = 4;
            const colorRenderbuffer = new GLRenderbuffer(gl, width, height, gl.RGBA8, msaaSamples);
            const depthRenderbuffer = new GLRenderbuffer(gl, width, height, gl.DEPTH_COMPONENT16, msaaSamples);
            const resolveTexture = new GLTexture(gl, { width, height, format: gl.RGBA });

            const renderFramebuffer = new GLFramebuffer(gl, colorRenderbuffer, depthRenderbuffer);
            const resolveFramebuffer = new GLFramebuffer(gl, resolveTexture);

            let y = 0;
            gl.onDrawFrame.addListener(function() {
                renderFramebuffer.bind();
                gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);

                gl.disable(gl.DEPTH_TEST); // ... and disabling DEPTH_TEST ...
                gl.depthMask(false);
                texture.bind();
                shader.setUniform('y', 0.0);
                shader.drawMesh(plane);

                gl.enable(gl.DEPTH_TEST); // ... triggers the bad depth buffer for this draw
                gl.depthMask(true);
                texture2.bind();
                shader.setUniform('y', y);
                shader.drawMesh(plane2);

                renderFramebuffer.unbind();

                gl.bindFramebuffer(gl.READ_FRAMEBUFFER, renderFramebuffer.handle);
                gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, resolveFramebuffer.handle);

                gl.clearBufferfv(gl.COLOR, 0, [0.0, 0.0, 0.0, 0.0]);
                gl.blitFramebuffer(0, 0, width, height,
                                0, 0, width, height,
                                gl.COLOR_BUFFER_BIT, gl.LINEAR);

                gl.bindFramebuffer(gl.READ_FRAMEBUFFER, null);
                gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, null);

                resolveTexture.bind();
                shader.setUniform('y', 0);
                shader.drawMesh(plane);

                y += 0.01;
                if (y > 1.0)
                    y = -0.5;
            });
            gl.animate();
        </script>
    </body>
</html>